# ğŸ‰ å®Œæ•´ç›‘æ§ç³»ç»Ÿå®ç°æ€»ç»“

## å®ç°æ¦‚è¿°

å·²å®Œæˆ VPS Stock Monitor çš„å®Œæ•´å®ç°ï¼ŒåŒ…æ‹¬ï¼š
- âœ… æ ¸å¿ƒç›‘æ§é€»è¾‘
- âœ… RESTful API
- âœ… KV å­˜å‚¨
- âœ… é€šçŸ¥ç³»ç»Ÿ
- âœ… å®šæ—¶ä»»åŠ¡

## æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Cloudflare Workers                        â”‚
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚   Hono     â”‚â”€â”€â”€â”€â”€>â”‚  Monitor   â”‚â”€â”€â”€â”€â”€>â”‚  Provider  â”‚   â”‚
â”‚  â”‚   Router   â”‚      â”‚  Service   â”‚      â”‚   (Dmit)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚         â”‚                   â”‚                               â”‚
â”‚         â”‚                   â–¼                               â”‚
â”‚         â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                         â”‚
â”‚         â”‚            â”‚  Storage   â”‚                         â”‚
â”‚         â”‚            â”‚  Service   â”‚                         â”‚
â”‚         â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                         â”‚
â”‚         â”‚                   â”‚                               â”‚
â”‚         â–¼                   â–¼                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚  â”‚Notificationâ”‚      â”‚     KV     â”‚                        â”‚
â”‚  â”‚  Manager   â”‚      â”‚  Namespace â”‚                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚         â”‚                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚
          â–¼
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â”‚  Telegram  â”‚
   â”‚    Bot     â”‚
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ–‡ä»¶ç»“æ„

```
src/
â”œâ”€â”€ index.ts                    # ä¸»å…¥å£ï¼Œè·¯ç”±å®šä¹‰
â”œâ”€â”€ models/
â”‚   â””â”€â”€ types.ts               # ç±»å‹å®šä¹‰
â”œâ”€â”€ providers/
â”‚   â”œâ”€â”€ base.ts                # Provider æ¥å£
â”‚   â”œâ”€â”€ dmit.ts                # Dmit Provider å®ç°
â”‚   â”œâ”€â”€ dmit.test.ts           # Dmit Provider æµ‹è¯•
â”‚   â””â”€â”€ dmit-simple.ts         # ç®€åŒ–ç‰ˆå®ç°
â””â”€â”€ services/
    â”œâ”€â”€ storage.ts             # KV å­˜å‚¨æœåŠ¡
    â”œâ”€â”€ monitor.ts             # ç›‘æ§æœåŠ¡
    â””â”€â”€ notification.ts        # é€šçŸ¥æœåŠ¡
```

## æ ¸å¿ƒç»„ä»¶

### 1. å­˜å‚¨æœåŠ¡ (storage.ts)

**TargetStore**:
- `list()` - è·å–æ‰€æœ‰ç›‘æ§ç›®æ ‡
- `get(id)` - è·å–å•ä¸ªç›®æ ‡
- `create(input)` - åˆ›å»ºç›®æ ‡
- `update(id, patch)` - æ›´æ–°ç›®æ ‡
- `delete(id)` - åˆ é™¤ç›®æ ‡
- `listEnabled()` - è·å–å¯ç”¨çš„ç›®æ ‡

**StateStore**:
- `get(targetId)` - è·å–ç›‘æ§çŠ¶æ€
- `update(targetId, state)` - æ›´æ–°çŠ¶æ€
- `recordSuccess(targetId, status)` - è®°å½•æˆåŠŸ
- `recordError(targetId, error)` - è®°å½•å¤±è´¥
- `listAll()` - è·å–æ‰€æœ‰çŠ¶æ€

### 2. ç›‘æ§æœåŠ¡ (monitor.ts)

**MonitorService**:
- `checkTarget(target)` - æ£€æŸ¥å•ä¸ªç›®æ ‡
- `checkAllTargets()` - æ£€æŸ¥æ‰€æœ‰ç›®æ ‡
- `shouldNotify(target, status)` - åˆ¤æ–­æ˜¯å¦é€šçŸ¥
- `getTargetStore()` - è·å–å­˜å‚¨æœåŠ¡
- `getStateStore()` - è·å–çŠ¶æ€æœåŠ¡

### 3. é€šçŸ¥æœåŠ¡ (notification.ts)

**TelegramNotifier**:
- å‘é€ Telegram æ¶ˆæ¯
- Markdown æ ¼å¼åŒ–
- åŒ…å«åº“å­˜çŠ¶æ€ã€ä»·æ ¼ã€é“¾æ¥ç­‰ä¿¡æ¯

**ConsoleNotifier**:
- æ§åˆ¶å°è¾“å‡ºï¼ˆå¼€å‘ç¯å¢ƒï¼‰

**NotificationManager**:
- ç®¡ç†å¤šä¸ªé€šçŸ¥æœåŠ¡
- å¹¶å‘å‘é€é€šçŸ¥
- é”™è¯¯å¤„ç†

### 4. API è·¯ç”± (index.ts)

#### ç›‘æ§ç›®æ ‡ç®¡ç†
- `GET /api/targets` - è·å–æ‰€æœ‰ç›®æ ‡
- `POST /api/targets` - åˆ›å»ºç›®æ ‡
- `GET /api/targets/:id` - è·å–å•ä¸ªç›®æ ‡
- `PATCH /api/targets/:id` - æ›´æ–°ç›®æ ‡
- `DELETE /api/targets/:id` - åˆ é™¤ç›®æ ‡

#### çŠ¶æ€æŸ¥è¯¢
- `GET /api/status` - è·å–æ‰€æœ‰çŠ¶æ€
- `GET /api/status/:id` - è·å–å•ä¸ªçŠ¶æ€

#### æ‰‹åŠ¨æ£€æŸ¥
- `POST /api/check` - æ£€æŸ¥æ‰€æœ‰ç›®æ ‡
- `POST /api/check/:id` - æ£€æŸ¥å•ä¸ªç›®æ ‡

#### æµ‹è¯•ç«¯ç‚¹
- `GET /test-dmit?url=...` - æµ‹è¯• Dmit åº“å­˜

### 5. å®šæ—¶ä»»åŠ¡

**Cron Trigger**:
- å®šæ—¶æ£€æŸ¥æ‰€æœ‰å¯ç”¨çš„ç›®æ ‡
- æ¯”è¾ƒçŠ¶æ€å˜åŒ–
- å‘é€é€šçŸ¥
- æ›´æ–°çŠ¶æ€

## æ•°æ®æµ

### åˆ›å»ºç›‘æ§ç›®æ ‡

```
ç”¨æˆ·è¯·æ±‚
  â†“
POST /api/targets
  â†“
éªŒè¯ API Key
  â†“
åˆ›å»º MonitorService
  â†“
TargetStore.create()
  â†“
ä¿å­˜åˆ° KV
  â†“
è¿”å›ç›®æ ‡ä¿¡æ¯
```

### å®šæ—¶æ£€æŸ¥æµç¨‹

```
Cron è§¦å‘
  â†“
åˆ›å»º MonitorService
  â†“
è·å–æ‰€æœ‰å¯ç”¨çš„ç›®æ ‡
  â†“
å¹¶å‘æ£€æŸ¥æ¯ä¸ªç›®æ ‡
  â”œâ”€> è·å– Provider
  â”œâ”€> è°ƒç”¨ fetchStatus()
  â”œâ”€> è®°å½•çŠ¶æ€åˆ° KV
  â””â”€> åˆ¤æ–­æ˜¯å¦é€šçŸ¥
       â”œâ”€> æ£€æŸ¥é€šçŸ¥æ¡ä»¶
       â”œâ”€> æ£€æŸ¥é€šçŸ¥é—´éš”
       â””â”€> å‘é€é€šçŸ¥
            â””â”€> Telegram Bot
```

### é€šçŸ¥è§¦å‘æ¡ä»¶

```
è·å–ä¸Šæ¬¡çŠ¶æ€
  â†“
æ¯”è¾ƒæ–°æ—§çŠ¶æ€
  â”œâ”€> è¡¥è´§ï¼Ÿ(ç¼ºè´§ â†’ æœ‰è´§)
  â”œâ”€> ç¼ºè´§ï¼Ÿ(æœ‰è´§ â†’ ç¼ºè´§)
  â””â”€> ä»·æ ¼å˜åŒ–ï¼Ÿ
       â†“
æ£€æŸ¥é€šçŸ¥é—´éš”
  â†“
å‘é€é€šçŸ¥
  â†“
æ›´æ–° lastNotifiedAt
```

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

```env
# API å¯†é’¥ï¼ˆå¿…éœ€ï¼‰
API_KEY=your-secret-api-key

# Telegram é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
TELEGRAM_BOT_TOKEN=your-bot-token
TELEGRAM_CHAT_ID=your-chat-id
```

### Cron é…ç½®

åœ¨ `wrangler.toml` ä¸­ï¼š

```toml
[triggers]
crons = ["*/5 * * * *"]  # æ¯ 5 åˆ†é’Ÿ
```

## ä½¿ç”¨ç¤ºä¾‹

### 1. åˆ›å»ºç›‘æ§ç›®æ ‡

```bash
curl -X POST https://your-worker.workers.dev/api/targets \
  -H "X-API-Key: your-api-key" \
  -H "Content-Type: application/json" \
  -d '{
    "provider": "dmit",
    "url": "https://www.dmit.io/cart.php?gid=1",
    "enabled": true,
    "notifyOnRestock": true
  }'
```

### 2. æ‰‹åŠ¨æ£€æŸ¥

```bash
curl -X POST https://your-worker.workers.dev/api/check/target-id \
  -H "X-API-Key: your-api-key"
```

### 3. æŸ¥çœ‹çŠ¶æ€

```bash
curl https://your-worker.workers.dev/api/status \
  -H "X-API-Key: your-api-key"
```

## æµ‹è¯•

### å•å…ƒæµ‹è¯•

```bash
npm test
```

**è¦†ç›–**:
- âœ… Dmit Provider (29 ä¸ªæµ‹è¯•)
- âœ… æ‰€æœ‰è§£ææ–¹æ³•
- âœ… è¾¹ç¼˜æƒ…å†µå¤„ç†

### é›†æˆæµ‹è¯•

```bash
# å¯åŠ¨å¼€å‘æœåŠ¡å™¨
npm run dev:remote

# è¿è¡Œç¤ºä¾‹è„šæœ¬
./example-api-usage.sh
```

## éƒ¨ç½²

### 1. é…ç½®ç¯å¢ƒå˜é‡

åœ¨ Cloudflare Workers è®¾ç½®ä¸­æ·»åŠ ï¼š
- `API_KEY`
- `TELEGRAM_BOT_TOKEN`
- `TELEGRAM_CHAT_ID`

### 2. åˆ›å»º KV Namespace

```bash
npx wrangler kv:namespace create KV
npx wrangler kv:namespace create KV --preview
```

æ›´æ–° `wrangler.toml` ä¸­çš„ KV IDã€‚

### 3. éƒ¨ç½²

```bash
npm run deploy
```

## ç›‘æ§å’Œç»´æŠ¤

### æŸ¥çœ‹æ—¥å¿—

```bash
npx wrangler tail
```

### æ£€æŸ¥ KV å­˜å‚¨

```bash
# åˆ—å‡ºæ‰€æœ‰é”®
npx wrangler kv:key list --namespace-id=your-kv-id

# è·å–å€¼
npx wrangler kv:key get "target:xxx" --namespace-id=your-kv-id
```

### æ‰‹åŠ¨è§¦å‘ Cron

```bash
curl "https://your-worker.workers.dev/cdn-cgi/handler/scheduled"
```

## æ€§èƒ½ä¼˜åŒ–

### 1. å¹¶å‘æ£€æŸ¥

ä½¿ç”¨ `Promise.all()` å¹¶å‘æ£€æŸ¥å¤šä¸ªç›®æ ‡ï¼Œæé«˜æ•ˆç‡ã€‚

### 2. KV ç¼“å­˜

çŠ¶æ€å­˜å‚¨åœ¨ KV ä¸­ï¼Œé¿å…é‡å¤è®¡ç®—ã€‚

### 3. é”™è¯¯å¤„ç†

è®°å½•é”™è¯¯æ¬¡æ•°ï¼Œå¯ä»¥å®ç°è‡ªåŠ¨ç¦ç”¨å¤±è´¥çš„ç›®æ ‡ã€‚

## æ‰©å±•æ€§

### æ·»åŠ æ–° Provider

1. å®ç° `Provider` æ¥å£
2. åœ¨ `monitor.ts` ä¸­æ³¨å†Œ
3. æ·»åŠ æµ‹è¯•

ç¤ºä¾‹ï¼š

```typescript
export class NewProvider implements Provider {
  id = "new-provider";
  name = "New Provider";

  supports(target: MonitorTarget): boolean {
    // å®ç°æ”¯æŒåˆ¤æ–­
  }

  async fetchStatus(target: MonitorTarget): Promise<StockStatus> {
    // å®ç°åº“å­˜è·å–
  }
}
```

### æ·»åŠ æ–°é€šçŸ¥æ¸ é“

1. å®ç° `NotificationService` æ¥å£
2. åœ¨ `NotificationManager` ä¸­æ³¨å†Œ

ç¤ºä¾‹ï¼š

```typescript
export class EmailNotifier implements NotificationService {
  async send(target: MonitorTarget, status: StockStatus, reason: string) {
    // å®ç°é‚®ä»¶å‘é€
  }
}
```

## å·²çŸ¥é™åˆ¶

1. **KV é™åˆ¶**: å…è´¹è®¡åˆ’ 100,000 æ¬¡è¯»å–/å¤©
2. **Cron é™åˆ¶**: æœ€å°é—´éš” 1 åˆ†é’Ÿ
3. **è¯·æ±‚è¶…æ—¶**: 10 ç§’
4. **å¹¶å‘é™åˆ¶**: Workers å¹¶å‘è¯·æ±‚é™åˆ¶

## æœ€ä½³å®è·µ

1. **æ£€æŸ¥é—´éš”**: 5-10 åˆ†é’Ÿ
2. **é€šçŸ¥é—´éš”**: è‡³å°‘ 60 åˆ†é’Ÿ
3. **é”™è¯¯å¤„ç†**: ç›‘æ§ `errorCount`
4. **æ—¥å¿—è®°å½•**: ä½¿ç”¨ `wrangler tail` æŸ¥çœ‹æ—¥å¿—

## æ•…éšœæ’æŸ¥

### é—®é¢˜ï¼šæ²¡æœ‰æ”¶åˆ°é€šçŸ¥

**æ£€æŸ¥**:
1. Telegram é…ç½®æ˜¯å¦æ­£ç¡®
2. é€šçŸ¥æ¡ä»¶æ˜¯å¦æ»¡è¶³
3. `minNotifyInterval` æ˜¯å¦è¿‡é•¿
4. æŸ¥çœ‹ `lastNotifiedAt`

### é—®é¢˜ï¼šæ£€æŸ¥å¤±è´¥

**æ£€æŸ¥**:
1. URL æ˜¯å¦æ­£ç¡®
2. Provider æ˜¯å¦æ”¯æŒ
3. ç½‘ç»œæ˜¯å¦å¯è¾¾
4. æŸ¥çœ‹é”™è¯¯æ—¥å¿—

### é—®é¢˜ï¼šAPI è¿”å› 401

**æ£€æŸ¥**:
1. API Key æ˜¯å¦æ­£ç¡®
2. è¯·æ±‚å¤´æ˜¯å¦åŒ…å« `X-API-Key`

## æ–‡æ¡£

- [API æ–‡æ¡£](./API.md) - å®Œæ•´çš„ API å‚è€ƒ
- [å¿«é€Ÿå¼€å§‹](./QUICK_START.md) - å¿«é€Ÿå¼€å§‹æŒ‡å—
- [æµ‹è¯•æŠ¥å‘Š](./TEST_REPORT.md) - æµ‹è¯•ç»“æœ

## ä¸‹ä¸€æ­¥

### å¯é€‰åŠŸèƒ½

1. **Web ç•Œé¢**: æ·»åŠ ç®¡ç†ç•Œé¢
2. **æ›´å¤š Provider**: æ”¯æŒå…¶ä»– VPS æä¾›å•†
3. **é«˜çº§é€šçŸ¥**: æ”¯æŒé‚®ä»¶ã€Discord ç­‰
4. **ç»Ÿè®¡åˆ†æ**: åº“å­˜å˜åŒ–è¶‹åŠ¿
5. **è‡ªåŠ¨ç¦ç”¨**: é”™è¯¯æ¬¡æ•°è¿‡å¤šè‡ªåŠ¨ç¦ç”¨

### æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹é‡æ“ä½œ**: æ‰¹é‡æ›´æ–° KV
2. **ç¼“å­˜ç­–ç•¥**: ä¼˜åŒ– KV è¯»å†™
3. **å¹¶å‘æ§åˆ¶**: é™åˆ¶å¹¶å‘è¯·æ±‚æ•°

## æ€»ç»“

âœ… **å®Œæ•´å®ç°**:
- æ ¸å¿ƒç›‘æ§é€»è¾‘
- RESTful API
- KV å­˜å‚¨
- é€šçŸ¥ç³»ç»Ÿ
- å®šæ—¶ä»»åŠ¡

âœ… **ç”Ÿäº§å°±ç»ª**:
- å®Œæ•´çš„é”™è¯¯å¤„ç†
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- çµæ´»çš„é…ç½®
- å®Œå–„çš„æ–‡æ¡£

âœ… **æ˜“äºæ‰©å±•**:
- æ¨¡å—åŒ–è®¾è®¡
- æ¸…æ™°çš„æ¥å£
- æ’ä»¶å¼æ¶æ„

**ç³»ç»Ÿå·²ç»å¯ä»¥æŠ•å…¥ä½¿ç”¨ï¼** ğŸ‰
