name: Deploy

on:
  push:
    branches: ["main"]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
      - name: Install dependencies
        run: npm ci
      - name: Lint
        run: npm run lint
      - name: Test
        run: npm test
      - name: Ensure KV namespaces
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          KV_NAMESPACE_NAME_PROD: vps-stock-monitor-prod
          KV_NAMESPACE_NAME_PREVIEW: vps-stock-monitor-preview
        run: |
          set -euo pipefail

          api_base="https://api.cloudflare.com/client/v4/accounts/${CLOUDFLARE_ACCOUNT_ID}/storage/kv/namespaces"
          list_json=$(curl -sS -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" "$api_base")

          prod_id=$(echo "$list_json" | jq -r --arg name "$KV_NAMESPACE_NAME_PROD" '.result[] | select(.title==$name) | .id' | head -n1)
          if [ -z "$prod_id" ]; then
            prod_id=$(curl -sS -X POST -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" "$api_base" --data "{\"title\":\"$KV_NAMESPACE_NAME_PROD\"}" | jq -r '.result.id')
          fi

          preview_id=$(echo "$list_json" | jq -r --arg name "$KV_NAMESPACE_NAME_PREVIEW" '.result[] | select(.title==$name) | .id' | head -n1)
          if [ -z "$preview_id" ]; then
            preview_id=$(curl -sS -X POST -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" -H "Content-Type: application/json" "$api_base" --data "{\"title\":\"$KV_NAMESPACE_NAME_PREVIEW\"}" | jq -r '.result.id')
          fi

          export KV_PROD_ID="$prod_id"
          export KV_PREVIEW_ID="$preview_id"
          python - <<'PY'
          import os
          from pathlib import Path

          prod_id = os.environ["KV_PROD_ID"].strip()
          preview_id = os.environ["KV_PREVIEW_ID"].strip()

          path = Path("wrangler.toml")
          content = path.read_text()
          content = content.replace("replace-with-your-kv-namespace-id", prod_id)
          content = content.replace("replace-with-your-preview-kv-namespace-id", preview_id)
          Path("wrangler.ci.toml").write_text(content)
          PY
        shell: bash
      - name: Deploy to Cloudflare Workers
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: npx wrangler deploy --config wrangler.ci.toml
